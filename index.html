<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Medika Bazaar | AWB Master Pro</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- jsPDF + autoTable for PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --medika: #004a99;
            --danger: #dc3545;
            --locked: #e9ecef;
            --ready: #fffde7;
        }
        body {
            background: #f4f7f6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: var(--medika);
            color: white;
            border-bottom: 4px solid #e74c3c;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .scan-input {
            font-size: 2.4rem;
            height: 85px;
            text-align: center;
            font-weight: bold;
            background: var(--locked);
            border: 4px solid #ced4da;
            transition: all 0.25s;
        }
        .scan-input:focus {
            border-color: var(--medika);
            box-shadow: 0 0 0 0.25rem rgba(0,74,153,0.25);
        }
        #loaderOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.92);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--medika);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .counter-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            box-shadow: 0 8px 25px rgba(102,126,234,0.35);
            position: relative;
            overflow: hidden;
        }
        .counter-number {
            font-size: 6rem;
            font-weight: 900;
            line-height: 1;
            text-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .counter-label {
            font-size: 1.3rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.9;
            margin-top: 8px;
        }
        .stat-value {
            font-size: 2.1rem;
            font-weight: 700;
        }
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.85;
            text-transform: uppercase;
        }

        .voice-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            cursor: pointer;
        }

        .keyboard-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--medika);
            color: white;
            font-size: 1.8rem;
            border: none;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            z-index: 1000;
        }
        .keyboard-toggle.disabled {
            background: #6c757d;
        }

        .flash-success {
            animation: flash 0.6s;
        }
        @keyframes flash {
            0%,100% { background-color: transparent; }
            50% { background-color: rgba(40,167,69,0.15); }
        }

        @media print {
            .no-print { display: none !important; }
            #printView { display: block !important; }
        }
    </style>
</head>
<body>

<div id="loaderOverlay">
    <div class="spinner mb-3"></div>
    <h5 class="fw-bold text-primary">Processing...</h5>
</div>

<!-- Print layout -->
<div id="printView" style="display:none;">
    <h2 class="text-center fw-bold text-decoration-underline mb-4">MANIFEST</h2>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 id="p-courier" class="fw-bold"></h3>
        <h3 id="p-count" class="border border-dark px-4 py-2 rounded-pill"></h3>
    </div>
    <p>Operator: <b id="p-op"></b>  |  Date: <b id="p-date"></b></p>
    <div id="p-grid" style="display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));"></div>
</div>

<nav class="navbar navbar-dark py-3 no-print">
    <div class="container-fluid">
        <span class="fw-bold fs-5">MEDIKA BAZAAR LOGISTICS</span>
        <button class="btn btn-outline-light btn-sm" onclick="location.reload()">LOGOUT</button>
    </div>
</nav>

<button id="keyboardToggle" class="keyboard-toggle" onclick="toggleKeyboard()" title="Toggle keyboard input">‚å®Ô∏è</button>

<div class="container mt-4 no-print">

    <!-- Login -->
    <div id="loginView" class="row justify-content-center mt-5">
        <div class="col-md-5 col-lg-4">
            <div class="card p-5 text-center shadow">
                <h3 class="mb-4 text-primary">Logistics Login</h3>
                <input type="text" id="loginInput" class="form-control form-control-lg text-center mb-3" placeholder="Operator name or Admin pass" autocomplete="off">
                <button class="btn btn-primary btn-lg w-100" onclick="handleLogin()">ENTER</button>
            </div>
        </div>
    </div>

    <!-- Scanner View -->
    <div id="scannerView" style="display:none;">
        <div class="row g-4">
            <!-- Left column - Counter + Input -->
            <div class="col-lg-5">
                <div class="counter-display text-center mb-4">
                    <div class="counter-number" id="visualCounter">0</div>
                    <div class="counter-label">Parcels Scanned</div>
                    <div class="counter-stats mt-4">
                        <div class="stat-item">
                            <div class="stat-value" id="scanRate">0</div>
                            <div class="stat-label">Per Min</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="sessionTime">0:00</div>
                            <div class="stat-label">Session</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="lastScan">--</div>
                            <div class="stat-label">Last Scan</div>
                        </div>
                    </div>
                </div>

                <div class="card p-4 position-relative">
                    <span class="voice-badge badge bg-success fs-6 px-3 py-2" id="voiceBadge" onclick="toggleVoice()">üîä Voice ON</span>

                    <p class="text-center mb-3">Operator: <b id="displayUser"></b></p>

                    <select id="courierSelect" class="form-select form-select-lg mb-3 fw-bold" onchange="handleCourierChange()">
                        <option value="">-- SELECT COURIER --</option>
                        <option value="ST COURIER">ST COURIER</option>
                        <option value="BLUEDART">BLUEDART</option>
                        <option value="XPRESS BEES">XPRESS BEES</option>
                        <option value="DTDC">DTDC</option>
                        <option value="DELIVERY">DELIVERY</option>
                    </select>

                    <input type="text" id="awbInput" class="form-control scan-input" placeholder="LOCKED" disabled autocomplete="off">

                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-success btn-lg fw-bold" onclick="showSyncConfirmation()">COMPLETE & SYNC</button>
                        <div class="btn-group">
                            <button class="btn btn-outline-dark" onclick="triggerPrint('current')">Print Preview</button>
                            <button class="btn btn-outline-primary" onclick="exportToPDF('current')">Export PDF</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right column - List -->
            <div class="col-lg-7">
                <div class="card p-3">
                    <h5 class="text-primary mb-3">Scanned AWBs <span id="totalCount" class="badge bg-primary ms-2">0</span></h5>
                    <div class="table-responsive" style="max-height:520px;">
                        <table class="table table-hover table-sm text-center align-middle">
                            <thead class="table-light">
                                <tr><th>#</th><th>AWB Number</th><th></th></tr>
                            </thead>
                            <tbody id="scanBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin View placeholder (can be expanded later) -->
    <div id="adminView" style="display:none;">
        <h4 class="text-center my-5 text-muted">Admin Panel ‚Äì coming soon</h4>
    </div>

</div>

<!-- Modals -->
<div class="modal fade" id="syncModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Confirm Sync</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-5">
                <h1 id="confCount" class="display-3 fw-bold mb-4">0</h1>
                <p class="lead">parcels will be synced & emailed</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success px-5" onclick="doSync()">CONFIRM</button>
            </div>
        </div>
    </div>
</div>

<!-- Audio -->
<audio id="beepOk" src="https://assets.mixkit.co/active_storage/sfx/1110/1110-preview.mp3"></audio>
<audio id="beepError" src="https://assets.mixkit.co/active_storage/sfx/2851/2851-preview.mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Globals
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let items = [];
let opName = "";
let voiceEnabled = true;
let keyboardEnabled = true;
let sessionStartTime = null;
let scanTimestamps = [];
let sessionTimerInterval = null;

const today = new Date().toISOString().split('T')[0];

// Elements
const els = {
    visualCounter: document.getElementById('visualCounter'),
    scanRate: document.getElementById('scanRate'),
    sessionTime: document.getElementById('sessionTime'),
    lastScan: document.getElementById('lastScan'),
    totalCount: document.getElementById('totalCount'),
    scanBody: document.getElementById('scanBody'),
    awbInput: document.getElementById('awbInput'),
    courierSelect: document.getElementById('courierSelect'),
    displayUser: document.getElementById('displayUser'),
    voiceBadge: document.getElementById('voiceBadge'),
    keyboardBtn: document.getElementById('keyboardToggle'),
    confCount: document.getElementById('confCount')
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Utility Functions
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function speak(text) {
    if (!voiceEnabled) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'en-US';
    speechSynthesis.speak(u);
}

function flashSuccess() {
    const card = document.querySelector('#scannerView .card');
    if (card) {
        card.classList.add('flash-success');
        setTimeout(() => card.classList.remove('flash-success'), 700);
    }
}

function updateVisualCounter() {
    const count = items.length;
    els.visualCounter.textContent = count;
    els.visualCounter.classList.add('pulse-animation');
    setTimeout(() => els.visualCounter.classList.remove('pulse-animation'), 600);
    els.totalCount.textContent = count;
}

function updateScanRate() {
    const now = Date.now();
    scanTimestamps = scanTimestamps.filter(t => now - t < 60000);
    els.scanRate.textContent = scanTimestamps.length;
}

function updateSessionTimer() {
    if (!sessionStartTime) return;
    const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
    const m = Math.floor(elapsed / 60);
    const s = elapsed % 60;
    els.sessionTime.textContent = `\( {m}: \){s.toString().padStart(2,'0')}`;
}

function updateLastScan() {
    const now = new Date();
    els.lastScan.textContent = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Core Logic
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleLogin() {
    const val = document.getElementById('loginInput').value.trim();
    if (!val) return alert("Please enter name or passcode");

    if (val === "0000") {
        document.getElementById('loginView').style.display = 'none';
        document.getElementById('adminView').style.display = 'block';
        return;
    }

    opName = val;
    els.displayUser.textContent = opName;

    document.getElementById('loginView').style.display = 'none';
    document.getElementById('scannerView').style.display = 'block';

    startSession();
}

function startSession() {
    sessionStartTime = Date.now();
    scanTimestamps = [];
    sessionTimerInterval = setInterval(() => {
        updateSessionTimer();
        updateScanRate();
    }, 1000);
}

function handleCourierChange() {
    const ready = els.courierSelect.value !== "";
    els.awbInput.disabled = !ready;
    els.awbInput.placeholder = ready ? "READY ‚Äì Scan AWB" : "LOCKED";
    if (ready && keyboardEnabled) els.awbInput.focus();
}

function toggleVoice() {
    voiceEnabled = !voiceEnabled;
    els.voiceBadge.textContent = voiceEnabled ? 'üîä Voice ON' : 'üîá Voice OFF';
    els.voiceBadge.className = voiceEnabled ? 'voice-badge badge bg-success' : 'voice-badge badge bg-secondary';
    speak(voiceEnabled ? 'Voice enabled' : 'Voice disabled');
}

function toggleKeyboard() {
    keyboardEnabled = !keyboardEnabled;
    els.keyboardBtn.classList.toggle('disabled', !keyboardEnabled);
    els.awbInput.readOnly = !keyboardEnabled;
    if (keyboardEnabled && !els.awbInput.disabled) els.awbInput.focus();
}

els.awbInput.addEventListener('change', function(e) {
    const code = this.value.trim().toUpperCase();
    if (code.length < 6) {
        this.value = '';
        return;
    }

    if (items.includes(code)) {
        document.getElementById('beepError').play().catch(()=>{});
        alert("Duplicate AWB!");
        speak("Duplicate");
        this.value = '';
        return;
    }

    items.push(code);
    scanTimestamps.push(Date.now());

    renderList();
    updateVisualCounter();
    updateScanRate();
    updateLastScan();
    speak(items.length);

    document.getElementById('beepOk').play().catch(()=>{});
    flashSuccess();

    this.value = '';
    if (keyboardEnabled) this.focus();
});

function renderList() {
    els.scanBody.innerHTML = items.map((awb, i) => `
        <tr>
            <td>${i+1}</td>
            <td class="font-monospace">${awb}</td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="removeItem(${i})">√ó</button></td>
        </tr>
    `).join('');
}

window.removeItem = function(idx) {
    items.splice(idx, 1);
    renderList();
    updateVisualCounter();
    updateScanRate();
    speak(items.length);
};

function showSyncConfirmation() {
    if (items.length === 0) return alert("No parcels scanned yet.");
    els.confCount.textContent = items.length;
    new bootstrap.Modal(document.getElementById('syncModal')).show();
}

window.doSync = function() {
    bootstrap.Modal.getInstance(document.getElementById('syncModal')).hide();
    document.getElementById('loaderOverlay').style.display = 'flex';

    setTimeout(() => {
        alert("Sync completed (mock)\n" + items.length + " AWBs sent.");
        document.getElementById('loaderOverlay').style.display = 'none';

        items = [];
        renderList();
        updateVisualCounter();
        updateScanRate();
        updateLastScan();
    }, 1200);
};

// PDF Export (current session)
window.exportToPDF = function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "landscape" });

    doc.setFontSize(18);
    doc.text(`MANIFEST - ${els.courierSelect.value || 'Unknown'}`, 20, 25);

    doc.setFontSize(12);
    doc.text(`Operator: ${opName}    Date: ${today}    Total: ${items.length}`, 20, 38);

    const tableData = items.map((awb, i) => [i+1, awb]);

    doc.autoTable({
        startY: 50,
        head: [['No', 'AWB Number']],
        body: tableData,
        theme: 'grid',
        styles: { fontSize: 10, cellPadding: 4 },
        headStyles: { fillColor: [0,74,153] },
        columnStyles: { 0: { cellWidth: 25 }, 1: { cellWidth: 'auto' } }
    });

    doc.save(`manifest-${today}.pdf`);
};

// Print preview (simple)
window.triggerPrint = function() {
    const printDiv = document.getElementById('printView');
    document.getElementById('p-courier').textContent = els.courierSelect.value || 'Unknown Courier';
    document.getElementById('p-op').textContent = opName;
    document.getElementById('p-date').textContent = today;
    document.getElementById('p-count').textContent = items.length;

    const grid = document.getElementById('p-grid');
    grid.innerHTML = '';

    const cols = 2; // change to 3 or 4 if you want
    const perCol = Math.ceil(items.length / cols);

    for (let c = 0; c < cols; c++) {
        const chunk = items.slice(c * perCol, (c+1) * perCol);
        if (chunk.length === 0) continue;

        let html = '<table class="table table-bordered table-sm"><thead><tr><th>#</th><th>AWB</th></tr></thead><tbody>';
        chunk.forEach((awb, i) => {
            html += `<tr><td>\( {c*perCol + i + 1}</td><td> \){awb}</td></tr>`;
        });
        html += '</tbody></table>';
        grid.innerHTML += html;
    }

    window.print();
};

console.log("Medika AWB Scanner ‚Üí loaded");
</script>
</body>
</html>