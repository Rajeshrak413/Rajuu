<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medika Bazaar | AWB Master Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root { --medika: #004a99; --danger: #dc3545; --locked: #e9ecef; --ready: #fffde7; }
        body { background: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: var(--medika); color: white; border-bottom: 4px solid #e74c3c; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .scan-input { font-size: 2.2rem; height: 80px; border: 4px solid #ced4da; text-align: center; font-weight: bold; background: var(--locked); transition: 0.3s; }
        #scannerView, #adminView, #printView { display: none; }
        .status-badge { cursor: pointer; transition: 0.2s; }
        .status-badge:hover { opacity: 0.7; transform: scale(1.05); }

        #loaderOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--medika); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .keyboard-toggle {
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%;
            background: var(--medika); color: white; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-size: 24px; cursor: pointer; z-index: 1000; transition: all 0.3s;
        }
        .keyboard-toggle:hover { transform: scale(1.1); background: #003377; }
        .keyboard-toggle.disabled { background: #6c757d; }

        .voice-badge { position: absolute; top: 10px; right: 10px; cursor: pointer; transition: 0.2s; }
        .voice-badge:hover { transform: scale(1.1); }

        .counter-display {
            position: relative; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            overflow: hidden;
        }
        .counter-display::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }
        .counter-number { font-size: 5rem; font-weight: 900; color: white; text-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; z-index: 1; line-height: 1; }
        .counter-number.pulse-animation { animation: countPulse 0.6s ease-out; }
        @keyframes countPulse { 0% { transform: scale(1); } 30% { transform: scale(1.3); color: #ffd700; } 100% { transform: scale(1); } }
        .counter-label { font-size: 1.2rem; color: rgba(255,255,255,0.9); text-transform: uppercase; letter-spacing: 3px; font-weight: 600; position: relative; z-index: 1; margin-top: 10px; }
        .counter-stats { display: flex; justify-content: space-around; margin-top: 15px; position: relative; z-index: 1; }
        .stat-item { text-align: center; color: white; }
        .stat-value { font-size: 1.8rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.75rem; opacity: 0.8; text-transform: uppercase; }
        .progress-ring { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); width: 80px; height: 80px; }
        .progress-ring circle { fill: none; stroke: rgba(255,255,255,0.3); stroke-width: 8; }
        .progress-ring .progress { stroke: #ffd700; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }

        @keyframes scanFlash { 0% { background-color: inherit; } 50% { background-color: rgba(40, 167, 69, 0.3); } 100% { background-color: inherit; } }
        .flash-success { animation: scanFlash 0.5s ease-out; }

        @media print {
            body * { visibility: hidden; }
            #printView, #printView * { visibility: visible; }
            #printView { position: absolute; left: 0; top: 0; width: 100%; display: block !important; padding: 10px; }
            .print-table { width: 100%; border-collapse: collapse; border: 1px solid black; }
            .print-table th, .print-table td { border: 1px solid black; padding: 4px; text-align: center; font-size: 10pt; }
            .keyboard-toggle, .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div id="loaderOverlay">
    <div class="spinner mb-3"></div>
    <h5 class="fw-bold text-primary">Processing...</h5>
</div>

<div id="printView">
    <div class="text-center h2 fw-bold text-decoration-underline">MANIFEST</div>
    <div class="d-flex justify-content-between mt-3">
        <h1 id="p-courier" class="fw-bold"></h1>
        <h1 id="p-count" class="border border-dark px-3 rounded-circle"></h1>
    </div>
    <hr>
    <p>Op: <b id="p-op"></b> | Date: <b id="p-date"></b></p>
    <div class="print-grid mt-3" id="p-grid-container" style="display: grid; gap: 10px;"></div>
</div>

<nav class="navbar py-3 no-print shadow">
    <div class="container d-flex justify-content-between">
        <b>MEDIKA BAZAAR LOGISTICS</b>
        <button class="btn btn-sm btn-outline-light" onclick="location.reload()">LOGOUT</button>
    </div>
</nav>

<button id="keyboardToggle" class="keyboard-toggle no-print" onclick="toggleKeyboard()" title="Toggle Keyboard">âŒ¨ï¸</button>

<div class="container mt-4 no-print">
    <div id="loginView" class="row justify-content-center mt-5">
        <div class="col-md-5 card p-5 text-center shadow">
            <h3 class="mb-4 text-primary">Logistics Login</h3>
            <input type="text" id="loginInput" class="form-control mb-3 text-center fs-4" placeholder="Name or Admin Pass">
            <button class="btn btn-primary w-100 btn-lg shadow" onclick="handleLogin()">ENTER</button>
        </div>
    </div>

    <div id="scannerView" class="row g-4" style="display:none;">
        <div class="col-lg-5">
            <div class="counter-display text-center">
                <div class="counter-number" id="visualCounter">0</div>
                <div class="counter-label">Parcels Scanned</div>
                <div class="counter-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="scanRate">0</span>
                        <span class="stat-label">Per Min</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="sessionTime">0:00</span>
                        <span class="stat-label">Session</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="lastScan">--</span>
                        <span class="stat-label">Last Scan</span>
                    </div>
                </div>
                <svg class="progress-ring" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="40"></circle>
                    <circle cx="50" cy="50" r="40" class="progress" id="progressCircle" stroke-dasharray="251.2" stroke-dashoffset="251.2"></circle>
                </svg>
            </div>

            <div class="card p-4 shadow-sm border-top border-primary border-3 text-center position-relative">
                <span class="voice-badge badge bg-success" onclick="toggleVoice()" id="voiceBadge">ğŸ”Š Voice ON</span>
                <p>Operator: <b id="displayUser"></b></p>
                <select id="courierSelect" class="form-select form-select-lg mb-3 fw-bold" onchange="handleCourierChange()">
                    <option value="">-- SELECT COURIER --</option>
                    <option value="ST COURIER">ST COURIER</option>
                    <option value="BLUEDART">BLUEDART</option>
                    <option value="XPRESS BEES">XPRESS BEES</option>
                    <option value="DTDC">DTDC</option>
                    <option value="DELIVERY">DELIVERY</option>
                </select>
                <input type="text" id="awbInput" class="form-control scan-input" placeholder="LOCKED" disabled>
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-success btn-lg fw-bold" onclick="showSyncConfirmation()">COMPLETE & SYNC</button>
                    <div class="btn-group w-100">
                        <button class="btn btn-dark" onclick="userPrint()">PRINT PREVIEW</button>
                        <button class="btn btn-info" onclick="exportManifestToPDF('temp')">PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7 card p-3 shadow-sm border-top border-primary border-3">
            <h5 class="text-primary mb-3">Scanned Parcels: <span id="totalCount" class="badge bg-primary">0</span></h5>
            <div class="table-responsive" style="max-height: 450px;">
                <table class="table table-hover text-center">
                    <thead><tr><th>SL</th><th>AWB</th><th>Action</th></tr></thead>
                    <tbody id="scanBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Admin view and other sections remain the same as in previous version -->
    <!-- ... (omitted for brevity - copy from previous full version if needed) ... -->
</div>

<!-- Keep your modals, audio tags, etc. -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Global variables
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let items = [];
let opName = "";
let voiceEnabled = true;
let keyboardEnabled = true;
let sessionStartTime = null;
let scanTimestamps = [];
let sessionTimer = null;

const today = new Date().toISOString().split('T')[0];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Basic functions
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function speakCount(count) {
    if (!voiceEnabled) return;
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(count.toString());
        utterance.lang = 'en-US';
        window.speechSynthesis.speak(utterance);
    }
}

function toggleVoice() {
    voiceEnabled = !voiceEnabled;
    const badge = document.getElementById('voiceBadge');
    badge.textContent = voiceEnabled ? 'ğŸ”Š Voice ON' : 'ğŸ”‡ Voice OFF';
    badge.className = voiceEnabled ? 'voice-badge badge bg-success' : 'voice-badge badge bg-secondary';
    speakCount(voiceEnabled ? 'Voice enabled' : 'Voice disabled');
}

function toggleKeyboard() {
    keyboardEnabled = !keyboardEnabled;
    const input = document.getElementById('awbInput');
    const btn = document.getElementById('keyboardToggle');
    if (keyboardEnabled) {
        input.removeAttribute('readonly');
        btn.classList.remove('disabled');
    } else {
        input.setAttribute('readonly', 'readonly');
        btn.classList.add('disabled');
    }
}

function handleLogin() {
    const val = document.getElementById('loginInput').value.trim();
    if (!val) return alert("Enter name or pass");
    
    if (val === "0000") {
        document.getElementById('loginView').style.display = 'none';
        document.getElementById('adminView').style.display = 'block';
        console.log("Admin mode");
        return;
    }

    opName = val;
    document.getElementById('displayUser').textContent = opName;
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('scannerView').style.display = 'flex';
    
    startSessionTracking();
    console.log("Logged in as:", opName);
}

function startSessionTracking() {
    sessionStartTime = Date.now();
    scanTimestamps = [];
    updateSessionTimer();
    sessionTimer = setInterval(updateSessionTimer, 1000);
}

function updateSessionTimer() {
    if (!sessionStartTime) return;
    const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
    const min = Math.floor(elapsed / 60);
    const sec = elapsed % 60;
    document.getElementById('sessionTime').textContent = `\( {min}: \){sec.toString().padStart(2, '0')}`;
}

function updateScanRate() {
    const now = Date.now();
    scanTimestamps = scanTimestamps.filter(t => now - t < 60000);
    document.getElementById('scanRate').textContent = scanTimestamps.length;
}

function updateVisualCounter(count) {
    const el = document.getElementById('visualCounter');
    el.textContent = count;
    el.classList.add('pulse-animation');
    setTimeout(() => el.classList.remove('pulse-animation'), 600);
}

function handleCourierChange() {
    const courier = document.getElementById('courierSelect').value;
    const input = document.getElementById('awbInput');
    if (courier) {
        input.disabled = false;
        input.placeholder = "READY - Scan AWB";
        if (keyboardEnabled) input.focus();
    } else {
        input.disabled = true;
        input.placeholder = "LOCKED";
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AWB scanning logic
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('awbInput').addEventListener('change', function(e) {
    const val = this.value.trim().toUpperCase();
    if (val.length < 6) {
        this.value = '';
        return;
    }

    if (items.includes(val)) {
        alert("Duplicate AWB!");
        speakCount("Duplicate");
        this.value = '';
        return;
    }

    items.push(val);
    scanTimestamps.push(Date.now());

    renderScanList();
    updateVisualCounter(items.length);
    updateScanRate();
    speakCount(items.length);

    this.value = '';
    this.focus();

    // Flash effect
    const card = document.querySelector('#scannerView .card');
    card.classList.add('flash-success');
    setTimeout(() => card.classList.remove('flash-success'), 600);
});

function renderScanList() {
    const tbody = document.getElementById('scanBody');
    tbody.innerHTML = '';
    items.forEach((awb, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${i+1}</td>
            <td>${awb}</td>
            <td><button class="btn btn-sm btn-danger" onclick="removeAwb(${i})">Ã—</button></td>
        `;
        tbody.appendChild(tr);
    });
    document.getElementById('totalCount').textContent = items.length;
}

function removeAwb(index) {
    items.splice(index, 1);
    renderScanList();
    updateVisualCounter(items.length);
    updateScanRate();
    speakCount(items.length);
}

// Add more functions (sync, pdf, print, admin...) as needed from previous versions

console.log("AWB Master Pro script loaded");
</script>
</body>
</html>