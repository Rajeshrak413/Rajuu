<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard | MEDIKA BAZAAR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .admin-card { border-left: 6px solid #004a99; transition: 0.3s; }
        .admin-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark px-4 mb-4 shadow">
    <span class="navbar-brand">MEDIKA BAZAAR ADMIN DASHBOARD</span>
</nav>

<div class="container">
    <div id="login" class="card p-4 mx-auto shadow-sm" style="max-width: 400px; margin-top: 100px;">
        <h4 class="text-center mb-4 text-primary">Admin Access</h4>
        <input type="password" id="p" class="form-control mb-3 p-3" placeholder="Enter Password (0000)">
        <button class="btn btn-primary w-100 btn-lg" onclick="auth()">ACCESS RECORDS</button>
    </div>

    <div id="dashboard" class="d-none">
        <h3 class="mb-4">Synced User Data</h3>
        <div id="dataList" class="row"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCynM9SUrwBGKjzuXuNjnbQERLjnhM4j2k",
        authDomain: "awbscan-49c04.firebaseapp.com",
        projectId: "awbscan-49c04",
        storageBucket: "awbscan-49c04.firebasestorage.app",
        messagingSenderId: "269309952447",
        appId: "1:269309952447:web:7e0e524b157e7a9904610a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.auth = () => {
        if(document.getElementById('p').value === "0000") {
            document.getElementById('login').classList.add('d-none');
            document.getElementById('dashboard').classList.remove('d-none');
            loadData();
        } else { alert("Incorrect Admin Password."); }
    }

    async function loadData() {
        const snap = await getDocs(query(collection(db, "manifests"), orderBy("time", "desc")));
        const list = document.getElementById('dataList');
        
        snap.forEach(doc => {
            const d = doc.data();
            const time = d.time ? d.time.toDate().toLocaleString() : "Syncing...";
            list.innerHTML += `
                <div class="col-md-4 mb-4">
                    <div class="card admin-card p-3 shadow-sm bg-white h-100">
                        <h5 class="text-primary mb-1">${d.courier}</h5>
                        <p class="small text-muted mb-3">${time}</p>
                        <p class="mb-3">Operator: <b>${d.operator}</b><br>Scanned: <b>${d.count} AWBs</b></p>
                        <button class="btn btn-success btn-sm w-100 py-2" onclick='window.downloadSingle(${JSON.stringify(d)})'>Download Individual Excel</button>
                    </div>
                </div>`;
        });
    }

    window.downloadSingle = (d) => {
        const wb = XLSX.utils.book_new();
        const wsData = [
            ["MEDIKA BAZAAR LOGISTICS REPORT"],
            ["Courier:", d.courier],
            ["Operator:", d.operator],
            ["Original Sync Time:", d.time ? new Date(d.time.seconds * 1000).toLocaleString() : "N/A"],
            [],
            ["SL", "AWB NUMBER"]
        ];
        d.awbs.forEach((a, i) => wsData.push([i+1, a]));
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Manifest");
        XLSX.writeFile(wb, `${d.courier}_${d.operator}.xlsx`);
    }
</script>
</body>
</html>
